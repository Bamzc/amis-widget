import{BasePlugin as e}from"amis-editor-core";export{BasePlugin,getSchemaTpl}from"amis-editor-core";import t from"react";import"jquery";import r from"react-dom";import o from"vue";function n(e,t,r=!0){const o=function(e,t=!0){const r=e&&e.__super?Object.create(e.__super,{__super:{value:e.__super,writable:!1,enumerable:!1}}):Object.create(Object.prototype);return t&&e&&Object.keys(e).forEach((t=>r[t]=e[t])),r}(e,r);return t&&Object.keys(t).forEach((e=>o[e]=t[e])),o}const s="[amis-widget]";var i,c;function a(t,r){const o=r?.rendererName||r?.type;if(t&&t.prototype instanceof e)return p(t,o),t;class n extends e{constructor(e){super(e)}}return Object.assign(n.prototype,new t),r&&Object.assign(n.prototype,r),p(n,o),n}function p(e,t){if(e&&function(e){let t=!1;if(!e)return!1;const r=new e;return r.rendererName?r.name?r.description?!r.tags||Array.isArray(r.tags)&&0===r.tags.length?console.error(`${s}自定义插件注册失败，自定义组件分类（tags）不能为空。`):r.panelTitle?(r.icon||Object.assign(e.prototype,{icon:"fa fa-file-code-o"}),t=!0):console.error(`${s}自定义插件注册失败，自定义组件配置面板Title（panelTitle）不能为空。`):console.error(`${s}自定义插件注册失败，自定义组件描述（description）不能为空。`):console.error(`${s}自定义插件注册失败，自定义组件名称（name）不能为空。`):console.error(`${s}自定义插件注册失败，关联渲染器（rendererName）不能为空。`),t}(e)){const r=t||(new e).rendererName;if(Object.assign(e.prototype,{isNpmCustomWidget:!0,name:r}),window&&window.postMessage){(function(e,t){window&&!window.AMISEditorCustomPlugins&&(window.AMISEditorCustomPlugins={});if(!window.AMISEditorCustomPlugins[e])return window.AMISEditorCustomPlugins[e]=t,e;console.error(`${s}注册自定义插件失败，已存在重名插件(${e})。`);return null})(r,e)&&(console.info(`${s}触发注册自定义插件(${r})事件`),window.postMessage({type:"amis-widget-register-event",eventMsg:`${s}注册一个自定义amis-editor插件`,editorPluginName:r},"*"))}}}function u(e){if(e&&("function"==typeof e||"object"==typeof e)){class r extends t.Component{dom;instance;constructor(t){super(t),this.domRef=this.domRef.bind(this),this.instance="function"==typeof e?new e:e}componentDidMount(){const{onMount:e}=this.instance;e&&e.apply(this.instance,[this.props])}componentDidUpdate(e){const{onUpdate:t}=this.instance;t&&t.apply(this.instance,[this.props,e])}componentWillUnmount(){const{onUnmout:e}=this.instance;e&&e.apply(this.instance,this.props)}domRef(e){this.instance.$root=this.dom=e,this._render()}_render(){if(!this.dom)return;let e=this.instance.template;"string"==typeof e?this.dom.innerHTML=e:"function"==typeof e&&(this.dom.innerHTML=e(this.props))}render(){return t.createElement("div",{ref:this.domRef})}}return r}}function m(e){if(e&&("function"==typeof e||"object"==typeof e)){class s extends t.Component{domRef;vm;constructor(e){super(e),this.domRef=t.createRef(),this.resolveAmisProps=this.resolveAmisProps.bind(this),this.renderChild=this.renderChild.bind(this)}componentDidMount(){const{amisData:t,amisFunc:r}=this.resolveAmisProps(),{data:s,...i}=e="function"==typeof e?new e:e;this.vm=new o({data:n(t,"function"==typeof s?s():s),...i,props:i.props||{}}),Object.keys(r).forEach((e=>{this.vm.$props[e]=r[e],"render"===e&&(this.vm.$props.renderChild=(e,t,r)=>{this.renderChild(e,t,r)})})),this.domRef.current.appendChild(this.vm.$mount().$el)}renderChild(e,t,o){let n=null;if(this.props.render&&t&&o){const s=this.props.render(e,t);n=r.render(s,document.getElementById(o))}return n}componentDidUpdate(){Object.keys(this.props).forEach((e=>"function"!=typeof this.props[e]&&(this.vm[e]=this.props[e]))),this.vm.$forceUpdate()}componentWillUnmount(){this.vm.$destroy()}resolveAmisProps(){let e={},t={};return Object.keys(this.props).forEach((r=>{const o=this.props[r];"function"==typeof o?e[r]=o:t[r]=o})),{amisData:t,amisFunc:e}}render(){return t.createElement("div",{ref:this.domRef})}}return s}}function d(e,t){if(!e)return;const r={type:"",usage:i.renderer,weight:0,framework:c.react};var o;if(t&&(o=t,"String"===Object.prototype.toString.call(o).slice(8,-1))?Object.assign(r,{type:t}):Object.assign(r,t),r&&!r.type)console.error(`${s}amis渲染器注册失败，渲染器类型（type）不能为空。`);else{r.framework=function(e){let t=c.react;if(!e)return t;let r=e.toLowerCase().trim();switch(r){case"jquery":case"jq":r=c.jquery;break;case"vue":case"vue2":case"vue 2":case"vue2.0":case"vue 2.0":r=c.vue2;break;case"vue3":case"vue 3":case"vue3.0":case"vue 3.0":r=c.vue3,console.error("amis-widget不支持vue3.0技术栈，请改用vue3-amis-widget支持。");break;default:r=c.react}return r}(r.framework),r.usage=function(e){let t=i.renderer;if(!e)return t;let r=e.toLowerCase().trim();switch(r){case"renderer":case"renderers":default:r=i.renderer;break;case"formitem":case"form-item":case"form item":r=i.formitem;break;case"options":case"option":case"formoption":case"form-option":case"form option":r=i.options}return r}(r.usage);const t={renderer:()=>{},formitem:()=>{},options:()=>{}},o={react:e=>e,vue2:m,vue3:m,jquery:u}[r.framework](e);if(t[r.usage]){if(window&&window.postMessage){const e=function(e,t){window&&!window.AmisCustomRenderers&&(window.AmisCustomRenderers={});if(!window.AmisCustomRenderers[e])return window.AmisCustomRenderers[e]=t,e;console.error(`${s}注册amis渲染器失败，已存在重名渲染器(${e})。`);return null}(r.type,{type:r.type,weight:r.weight,usage:r.usage,framework:r.framework,component:o});e&&(console.info(`${s}触发注册amis渲染器(${e})事件`),window.postMessage({type:"amis-renderer-register-event",eventMsg:`${s}注册一个自定义amis渲染器`,amisRenderer:{type:e,weight:r.weight,usage:r.usage}},"*"))}}else console.error(`${s}amis渲染器注册失败，暂不支持${r.usage}组件类型。`)}}!function(e){e.renderer="renderer",e.formitem="formitem",e.options="options"}(i||(i={})),function(e){e.react="react",e.vue2="vue2",e.vue3="vue3",e.jquery="jquery"}(c||(c={}));export{m as createVue2Component,a as registerAmisEditorPlugin,d as registerRendererByType};
