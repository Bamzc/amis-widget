import{registerEditorPlugin as e,BasePlugin as t}from"amis-editor";export{getSchemaTpl}from"amis-editor";import{utils as o,Renderer as r,FormItem as s,OptionsControl as n}from"amis";import i from"react";import"jquery";import a from"vue";var c,m;function p(e){let t=!1;if(!e)return!1;const o=new e;return o.rendererName?o.name?o.description?!o.tags||Array.isArray(o.tags)&&0===o.tags.length?console.error("[amis-widget]自定义插件注册失败，自定义组件分类（tags）不能为空。"):o.panelTitle?(o.icon||Object.assign(e.prototype,{icon:"fa fa-file-code-o"}),function(e){if(!e)return;e.rendererName&&e.rendererName.indexOf("npm-custom")<0&&(e.rendererName=`npm-custom-${e.rendererName}`);e.previewSchema&&e.previewSchema.type&&e.previewSchema.type.indexOf("npm-custom")<0&&(e.previewSchema.type=`npm-custom-${e.previewSchema.type}`);e.scaffold&&Array.isArray(e.scaffold)?e.scaffold.map((e=>(e.type.indexOf("npm-custom")<0&&(e.type=`npm-custom-${e.type}`),e))):e.scaffold&&e.scaffold.type&&e.scaffold.type.indexOf("npm-custom")<0&&(e.scaffold.type=`npm-custom-${e.scaffold.type}`)}(e.prototype),t=!0):console.error("[amis-widget]自定义插件注册失败，自定义组件配置面板Title（panelTitle）不能为空。"):console.error("[amis-widget]自定义插件注册失败，自定义组件描述（description）不能为空。"):console.error("[amis-widget]自定义插件注册失败，自定义组件名称（name）不能为空。"):console.error("[amis-widget]自定义插件注册失败，关联渲染器（rendererName）不能为空。"),t}function f(o,r){class s extends t{constructor(e){super(e)}}if(Object.assign(s.prototype,new o),Object.assign(s.prototype,r),p(s)){Object.assign(s.prototype,{isNpmCustomWidget:!0});const t=s.prototype;e(s),window&&window.postMessage&&window.postMessage({type:"amis-widget-register-event",eventMsg:"[amis-widget]注册一个自定义amis-editor插件",editorPluginName:t.name},"*"),console.info("[amis-widget]注册了一个自定义amis-editor插件:",t)}return s}function u(e){if(e&&("function"==typeof e||"object"==typeof e)){class t extends i.Component{dom;instance;constructor(t){super(t),this.domRef=this.domRef.bind(this),this.instance="function"==typeof e?new e:e}componentDidMount(){const{onMount:e}=this.instance;e&&e.apply(this.instance,[this.props])}componentDidUpdate(e){const{onUpdate:t}=this.instance;t&&t.apply(this.instance,[this.props,e])}componentWillUnmount(){const{onUnmout:e}=this.instance;e&&e.apply(this.instance,this.props)}domRef(e){this.instance.$root=this.dom=e,this._render()}_render(){if(!this.dom)return;let e=this.instance.template;"string"==typeof e?this.dom.innerHTML=e:"function"==typeof e&&(this.dom.innerHTML=e(this.props))}render(){return i.createElement("div",{ref:this.domRef})}}return t}}function d(e){if(e&&("function"==typeof e||"object"==typeof e)){class t extends i.Component{domRef;vm;constructor(e){super(e),this.domRef=i.createRef(),this.resolveAmisProps=this.resolveAmisProps.bind(this)}componentDidMount(){const{amisData:t,amisFunc:r}=this.resolveAmisProps(),{data:s,...n}=e="function"==typeof e?new e:e;this.vm=new a({data:o.extendObject(t,"function"==typeof s?s():s),...n}),Object.keys(r).forEach((e=>{const t=r[e];this.vm.$on(e,(e=>t&&t(...Array.isArray(e)?e:[e])))})),this.domRef.current.appendChild(this.vm.$mount().$el)}componentWillUnmount(){this.vm.$destroy()}resolveAmisProps(){let e={},t={};return Object.keys(this.props).forEach((o=>{const r=this.props[o];"function"==typeof r?e[o]=r:t[o]=r})),{amisData:t,amisFunc:e}}componentDidUpdate(){Object.keys(this.props).forEach((e=>"function"!=typeof this.props[e]&&(this.vm[e]=this.props[e])))}render(){return i.createElement("div",{ref:this.domRef})}}return t}}function l(e,t){if(!e)return;const o={type:"",usage:c.renderer,weight:0,framework:m.react};var i;if(t&&(i=t,"String"===Object.prototype.toString.call(i).slice(8,-1))?Object.assign(o,{type:t}):Object.assign(o,t),o&&!o.type)console.error("[amis-widget]自定义组件注册失败，自定义组件类型（type）不能为空。");else{o.type=function(e){let t=e;return e?(e&&e.indexOf("npm-custom")<0&&(t=`npm-custom-${e}`),t):t}(o.type),o.framework=function(e){let t=m.react;if(!e)return t;let o=e.toLowerCase().trim();switch(o){case"jquery":case"jq":o=m.jquery;break;case"vue":case"vue2":case"vue 2":case"vue2.0":case"vue 2.0":o=m.vue2;break;case"vue3":case"vue 3":case"vue3.0":case"vue 3.0":o=m.vue3,console.error("amis=widget不支持vue3.0技术栈，请改用vue3-amis-widget支持。");break;default:o=m.react}return o}(o.framework),o.usage=function(e){let t=c.renderer;if(!e)return t;let o=e.toLowerCase().trim();switch(o){case"renderer":case"renderers":default:o=c.renderer;break;case"formitem":case"form-item":case"form item":o=c.formitem;break;case"options":case"option":case"formoption":case"form-option":case"form option":o=c.options}return o}(o.usage);const t={renderer:r,formitem:s,options:n},i={react:e=>e,vue2:d,vue3:d,jquery:u}[o.framework](e);t[o.usage]?(t[o.usage]({type:o.type,weight:o.weight})(i),console.info("注册了一个自定义amis组件:",{type:o.type,weight:o.weight,component:i,framework:o.framework,usage:o.usage})):console.error(`[amis-widget]自定义组件注册失败，不存在${o.usage}自定义组件类型。`)}}!function(e){e.renderer="renderer",e.formitem="formitem",e.options="options"}(c||(c={})),function(e){e.react="react",e.vue2="vue2",e.vue3="vue3",e.jquery="jquery"}(m||(m={}));export{f as registerAmisEditorPlugin,l as registerRendererByType};
